package qrencode

import (
	"errors"
)

type versionNumber int

type ecbs struct {
	codewordsPerBlock int
	blocks            []ecb
}

type ecb struct {
	count, dataCodewords int
}

func (blocks ecbs) numBlocks() int {
	total := 0
	for _, block := range blocks.blocks {
		total += block.count
	}
	return total
}

func (blocks ecbs) totalECCodewords() int {
	return blocks.numBlocks() * blocks.codewordsPerBlock
}

var ecBlocks = [41][4]ecbs{
	{},
	{ // 1
		{10, []ecb{{1, 16}}}, // M
		{7, []ecb{{1, 19}}},  // L
		{17, []ecb{{1, 9}}},  // H
		{13, []ecb{{1, 13}}}, // Q
	},
	{ // 2
		{16, []ecb{{1, 28}}}, // M
		{10, []ecb{{1, 34}}}, // L
		{28, []ecb{{1, 16}}}, // H
		{22, []ecb{{1, 22}}}, // Q
	},
	{ // 3
		{26, []ecb{{1, 44}}}, // M
		{15, []ecb{{1, 55}}}, // L
		{22, []ecb{{2, 13}}}, // H
		{18, []ecb{{2, 17}}}, // Q
	},
	{ // 4
		{18, []ecb{{2, 32}}}, // M
		{20, []ecb{{1, 80}}}, // L
		{16, []ecb{{4, 9}}},  // H
		{26, []ecb{{2, 24}}}, // Q
	},
	{ // 5
		{24, []ecb{{2, 43}}},          // M
		{26, []ecb{{1, 108}}},         // L
		{22, []ecb{{2, 11}, {2, 12}}}, // H
		{18, []ecb{{2, 15}, {2, 16}}}, // Q
	},
	{ // 6
		{16, []ecb{{4, 27}}}, // M
		{18, []ecb{{2, 68}}}, // L
		{28, []ecb{{4, 15}}}, // H
		{24, []ecb{{4, 19}}}, // Q
	},
	{ // 7
		{18, []ecb{{4, 31}}},          // M
		{20, []ecb{{2, 78}}},          // L
		{26, []ecb{{4, 13}, {1, 14}}}, // H
		{18, []ecb{{2, 14}, {4, 15}}}, // Q
	},
	{ // 8
		{22, []ecb{{2, 38}, {2, 39}}}, // M
		{24, []ecb{{2, 97}}},          // L
		{26, []ecb{{4, 14}, {2, 15}}}, // H
		{22, []ecb{{4, 18}, {2, 19}}}, // Q
	},
	{ // 9
		{22, []ecb{{3, 36}, {2, 37}}}, // M
		{30, []ecb{{2, 116}}},         // L
		{24, []ecb{{4, 12}, {4, 13}}}, // H
		{20, []ecb{{4, 16}, {4, 17}}}, // Q
	},
	{ // 10
		{26, []ecb{{4, 43}, {1, 44}}}, // M
		{18, []ecb{{2, 68}, {2, 69}}}, // L
		{28, []ecb{{6, 15}, {2, 16}}}, // H
		{24, []ecb{{6, 19}, {2, 20}}}, // Q
	},
	{ // 11
		{30, []ecb{{1, 50}, {4, 51}}}, // M
		{20, []ecb{{4, 81}}},          // L
		{24, []ecb{{3, 12}, {8, 13}}}, // H
		{28, []ecb{{4, 22}, {4, 23}}}, // Q
	},
	{ // 12
		{22, []ecb{{6, 36}, {2, 37}}}, // M
		{24, []ecb{{2, 92}, {2, 93}}}, // L
		{28, []ecb{{7, 14}, {4, 15}}}, // H
		{26, []ecb{{4, 20}, {6, 21}}}, // Q
	},
	{ // 13
		{22, []ecb{{8, 37}, {1, 38}}},  // M
		{26, []ecb{{4, 107}}},          // L
		{22, []ecb{{12, 11}, {4, 12}}}, // H
		{24, []ecb{{8, 20}, {4, 21}}},  // Q
	},
	{ // 14
		{24, []ecb{{4, 40}, {5, 41}}},   // M
		{30, []ecb{{3, 115}, {1, 116}}}, // L
		{24, []ecb{{11, 12}, {5, 13}}},  // H
		{20, []ecb{{11, 16}, {5, 17}}},  // Q
	},
	{ // 15
		{24, []ecb{{5, 41}, {5, 42}}},  // M
		{22, []ecb{{5, 87}, {1, 88}}},  // L
		{24, []ecb{{11, 12}, {7, 13}}}, // H
		{30, []ecb{{5, 24}, {7, 25}}},  // Q
	},
	{ // 16
		{28, []ecb{{7, 45}, {3, 46}}},  // M
		{24, []ecb{{5, 98}, {1, 99}}},  // L
		{30, []ecb{{3, 15}, {13, 16}}}, // H
		{24, []ecb{{15, 19}, {2, 20}}}, // Q
	},
	{ // 17
		{28, []ecb{{10, 46}, {1, 47}}},  // M
		{28, []ecb{{1, 107}, {5, 108}}}, // L
		{28, []ecb{{2, 14}, {17, 15}}},  // H
		{28, []ecb{{1, 22}, {15, 23}}},  // Q
	},
	{ // 18
		{26, []ecb{{9, 43}, {4, 44}}},   // M
		{30, []ecb{{5, 120}, {1, 121}}}, // L
		{28, []ecb{{2, 14}, {19, 15}}},  // H
		{28, []ecb{{17, 22}, {1, 23}}},  // Q
	},
	{ // 19
		{26, []ecb{{3, 44}, {11, 44}}},  // M
		{28, []ecb{{3, 113}, {4, 114}}}, // L
		{26, []ecb{{9, 13}, {16, 14}}},  // H
		{26, []ecb{{17, 21}, {4, 22}}},  // Q
	},
	{ // 20
		{26, []ecb{{3, 41}, {13, 42}}},  // M
		{28, []ecb{{3, 107}, {5, 108}}}, // L
		{28, []ecb{{15, 15}, {10, 16}}}, // H
		{30, []ecb{{15, 24}, {5, 25}}},  // Q
	},
	{ // 21
		{26, []ecb{{17, 42}}},           // M
		{28, []ecb{{4, 116}, {4, 117}}}, // L
		{30, []ecb{{19, 16}, {6, 17}}},  // H
		{28, []ecb{{17, 22}, {6, 23}}},  // Q
	},
	{ // 22
		{28, []ecb{{17, 46}}},           // M
		{28, []ecb{{2, 111}, {7, 112}}}, // L
		{24, []ecb{{34, 13}}},           // H
		{30, []ecb{{7, 24}, {16, 25}}},  // Q
	},
	{ // 23
		{28, []ecb{{4, 47}, {14, 48}}},  // M
		{30, []ecb{{4, 121}, {5, 122}}}, // L
		{30, []ecb{{16, 15}, {14, 16}}}, // H
		{30, []ecb{{11, 24}, {14, 25}}}, // Q
	},
	{ // 24
		{28, []ecb{{6, 45}, {14, 46}}},  // M
		{30, []ecb{{6, 117}, {4, 118}}}, // L
		{30, []ecb{{30, 16}, {2, 17}}},  // H
		{30, []ecb{{11, 24}, {16, 25}}}, // Q
	},
	{ // 25
		{28, []ecb{{8, 47}, {13, 48}}},  // M
		{26, []ecb{{8, 106}, {4, 107}}}, // L
		{30, []ecb{{22, 15}, {13, 16}}}, // H
		{30, []ecb{{7, 24}, {22, 25}}},  // Q
	},
	{ // 26
		{28, []ecb{{19, 46}, {4, 47}}},   // M
		{28, []ecb{{10, 114}, {2, 115}}}, // L
		{30, []ecb{{33, 16}, {4, 17}}},   // H
		{28, []ecb{{28, 22}, {6, 23}}},   // Q
	},
	{ // 27
		{28, []ecb{{22, 45}, {3, 46}}},  // M
		{30, []ecb{{8, 122}, {4, 123}}}, // L
		{30, []ecb{{12, 15}, {28, 16}}}, // H
		{30, []ecb{{8, 23}, {26, 24}}},  // Q
	},
	{ // 28
		{28, []ecb{{3, 45}, {23, 46}}},   // M
		{30, []ecb{{3, 117}, {10, 118}}}, // L
		{30, []ecb{{11, 15}, {31, 16}}},  // H
		{30, []ecb{{4, 24}, {31, 25}}},   // Q
	},
	{ // 29
		{28, []ecb{{21, 45}, {7, 46}}},  // M
		{30, []ecb{{7, 116}, {7, 117}}}, // L
		{30, []ecb{{19, 15}, {26, 16}}}, // H
		{30, []ecb{{1, 32}, {37, 24}}},  // Q
	},
	{ // 30
		{28, []ecb{{19, 47}, {10, 48}}},  // M
		{30, []ecb{{5, 115}, {10, 116}}}, // L
		{30, []ecb{{23, 15}, {25, 16}}},  // H
		{30, []ecb{{15, 24}, {25, 25}}},  // Q
	},
	{ // 31
		{28, []ecb{{2, 46}, {29, 47}}},   // M
		{30, []ecb{{13, 115}, {3, 116}}}, // L
		{30, []ecb{{23, 15}, {28, 16}}},  // H
		{30, []ecb{{42, 24}, {1, 25}}},   // Q
	},
	{ // 32
		{28, []ecb{{10, 46}, {23, 47}}}, // M
		{30, []ecb{{17, 115}}},          // L
		{30, []ecb{{19, 15}, {35, 16}}}, // H
		{30, []ecb{{10, 24}, {35, 25}}}, // Q
	},
	{ // 33
		{28, []ecb{{14, 46}, {21, 47}}},  // M
		{30, []ecb{{17, 115}, {1, 116}}}, // L
		{30, []ecb{{11, 15}, {46, 16}}},  // H
		{30, []ecb{{29, 24}, {19, 25}}},  // Q
	},
	{ // 34
		{28, []ecb{{14, 16}, {23, 47}}},  // M
		{30, []ecb{{13, 115}, {6, 116}}}, // L
		{30, []ecb{{59, 16}, {1, 17}}},   // H
		{30, []ecb{{44, 24}, {7, 25}}},   // Q
	},
	{ // 35
		{28, []ecb{{12, 47}, {26, 48}}},  // M
		{30, []ecb{{12, 121}, {7, 122}}}, // L
		{30, []ecb{{22, 15}, {41, 16}}},  // H
		{30, []ecb{{39, 24}, {14, 25}}},  // Q
	},
	{ // 36
		{28, []ecb{{6, 47}, {34, 48}}},   // M
		{30, []ecb{{6, 121}, {14, 122}}}, // L
		{30, []ecb{{2, 15}, {64, 16}}},   // H
		{30, []ecb{{46, 24}, {10, 25}}},  // Q
	},
	{ // 37
		{28, []ecb{{29, 46}, {14, 47}}},  // M
		{30, []ecb{{17, 122}, {4, 123}}}, // L
		{30, []ecb{{24, 15}, {46, 16}}},  // H
		{30, []ecb{{49, 24}, {10, 25}}},  // Q
	},
	{ // 38
		{28, []ecb{{13, 46}, {32, 47}}},  // M
		{30, []ecb{{4, 122}, {18, 123}}}, // L
		{30, []ecb{{42, 15}, {32, 16}}},  // H
		{30, []ecb{{48, 24}, {14, 25}}},  // Q
	},
	{ // 39
		{28, []ecb{{40, 47}, {7, 48}}},   // M
		{30, []ecb{{20, 117}, {4, 118}}}, // L
		{30, []ecb{{10, 15}, {67, 16}}},  // H
		{30, []ecb{{43, 24}, {22, 25}}},  // Q
	},
	{ // 40
		{28, []ecb{{18, 47}, {31, 48}}},  // M
		{30, []ecb{{19, 118}, {6, 119}}}, // L
		{30, []ecb{{20, 15}, {61, 16}}},  // H
		{30, []ecb{{34, 24}, {34, 25}}},  // Q
	},
}

func (v versionNumber) totalCodewords() int {
	total := 0
	ecCodewords := ecBlocks[v][1].codewordsPerBlock
	for _, block := range ecBlocks[v][1].blocks {
		total += block.count * (block.dataCodewords + ecCodewords)
	}
	return total
}

func (v versionNumber) dimension() int {
	return 17 + 4*int(v)
}

func chooseVersion(bitCount int, ecLevel ECLevel) (versionNumber, error) {
	for v := versionNumber(1); v <= 40; v++ {
		if (bitCount+7)/8 <= v.totalCodewords()-ecBlocks[v][ecLevel].totalECCodewords() {
			return v, nil
		}
	}
	return versionNumber(0), errors.New("Content too large")
}
